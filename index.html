<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sisi 英语学习记录</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />

  <!-- iOS: 不提供 png 时，主屏幕可能用网页截图做图标（至少不会再引用孩子的旧图标） -->
  <!-- 如果你以后愿意加 png：把 href 改成你上传的 png 文件名即可 -->
  <link rel="apple-touch-icon" href="icon-512.png" />

  <!-- 动态 favicon（SVG data url），不需要额外文件 -->
  <link id="favicon" rel="icon" href="" />

  <style>
    :root{
      --bg1:#f6f7ff;
      --bg2:#eef7ff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(15,23,42,.10);
      --shadow: 0 10px 24px rgba(15,23,42,.08);
      --accent:#4f46e5;
      --accent2:#06b6d4;
      --danger:#ef4444;
      --ok:#16a34a;
      --chip:#f1f5f9;
      --radius:16px;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% 0%, var(--bg2), transparent 60%),
                  radial-gradient(1200px 800px at 90% 10%, #fdf2ff, transparent 60%),
                  linear-gradient(180deg, var(--bg1), #ffffff 60%);
      min-height:100vh;
    }
    header{
      position:sticky; top:0; z-index:10;
      background: rgba(246,247,255,.85);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px;}
    h1{margin:0;font-size:18px;letter-spacing:.2px;}
    .sub{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.3;}
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      padding-bottom:40px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr;}
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      padding:14px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:16px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .row{grid-template-columns:1fr;}
    }

    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px;}
    input, textarea, select{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 10px;
      font-size:14px;
      outline:none;
      background:#fff;
      color:var(--text);
    }
    textarea{min-height:84px;resize:vertical;}
    input:focus, textarea:focus, select:focus{border-color: rgba(79,70,229,.45); box-shadow: 0 0 0 4px rgba(79,70,229,.10);}

    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;}
    button{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-size:14px;
      cursor:pointer;
      box-shadow: 0 6px 14px rgba(15,23,42,.06);
    }
    button.primary{
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      color:#fff;
      border-color:transparent;
    }
    button.ghost{
      background:var(--chip);
    }
    button.danger{
      background:#fff;
      color:var(--danger);
      border-color: rgba(239,68,68,.35);
    }
    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }
    .toast{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      background: #f8fafc;
      border:1px dashed rgba(15,23,42,.14);
      color:var(--muted);
      font-size:12px;
    }
    .toast.ok{border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.06); color:#166534;}
    .toast.bad{border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.06); color:#991b1b;}

    .statbox{
      display:grid;
      gap:10px;
      margin-top:10px;
    }
    .pill{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
    }
    .pill b{font-size:15px;}
    .pill span{color:var(--muted);font-size:12px;}
    .pill .val{font-size:16px;color:var(--text);font-weight:700;}
    .mini{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;
    }
    .chip{
      background:var(--chip);
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
    }

    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;font-size:13px;vertical-align:top;}
    th{color:var(--muted);font-weight:600;font-size:12px;}
    .actions{display:flex;flex-direction:column;justify-content:center;align-items:center;gap:10px;min-width:86px;padding:8px 0;}
.actions button{padding:8px 12px;font-size:12px;min-width:72px;white-space:nowrap;}
td.right.actions{vertical-align:middle;}

    .right{text-align:right;}
    .countBadge{
      display:inline-flex; align-items:center; gap:8px;
      background: var(--chip);
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      float:right;
    }

    .backupBanner{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      background: linear-gradient(135deg, rgba(79,70,229,.08), rgba(6,182,212,.08));
      border:1px solid rgba(79,70,229,.14);
      color:#334155;
      font-size:12px;
      line-height:1.4;
    }

/* 修复 iOS 日期输入框显示异常 */
input[type="date"]{
  -webkit-appearance: none;
  appearance: none;
  text-align: left;
  padding: 10px 10px;
  height: 44px;
  line-height: 22px;
}
input[type="date"]::-webkit-date-and-time-value{
  text-align: left;
}
input[type="date"]::-webkit-calendar-picker-indicator{
  opacity: .65;
}

  </style>
</head>

<body>
<header>
  <div class="wrap">
    <h1>英语学习记录（Sisi）</h1>
    <div class="sub">每日记录 + 统计 + 已读书籍 words（数据保存在本机浏览器；建议每周导出一次备份）</div>
  </div>
</header>

<main class="wrap grid">
  <!-- 今日记录 -->
  <section class="card">
    <h2>每日记录</h2>

    <div class="row">
      <div>
        <label>日期</label>
        <input id="date" type="date" />
      </div>
      <div>
        <label>快速备注（可选）</label>
        <input id="note" placeholder="例如：状态一般、碎片时间多" />
      </div>
    </div>

    <h3 style="margin:14px 0 6px;font-size:14px;color:var(--muted);font-weight:700;">英语</h3>

    <div class="row">
      <div>
        <label>英语单词（个）</label>
        <input id="enWords" type="number" inputmode="numeric" min="0" placeholder="例如：30" />
      </div>
      <div>
        <label>阅读页数（页）</label>
        <input id="readPages" type="number" inputmode="numeric" min="0" placeholder="例如：12" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>阅读时长（分钟）</label>
        <input id="readMinutes" type="number" inputmode="numeric" min="0" placeholder="例如：25" />
      </div>
      <div>
        <label>阅读书名（可选）</label>
        <input id="readTitle" placeholder="例如：Atomic Habits" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>听力内容（可选，多行）</label>
        <textarea id="listenWhat" placeholder="例如：BBC Easy English - episode ..."></textarea>
      </div>
      <div>
        <label>听力时长（分钟）</label>
        <input id="listenMinutes" type="number" inputmode="numeric" min="0" placeholder="例如：20" />
        <div class="hint">提示：如果你只想记录时长，内容可以留空。</div>
      </div>
    </div>

    <h3 style="margin:14px 0 6px;font-size:14px;color:var(--muted);font-weight:700;">读完一本书（可选）</h3>
    <div class="row">
      <div>
        <label>书名</label>
        <input id="bookFinishedTitle" placeholder="例如：Charlotte’s Web" />
      </div>
      <div>
        <label>全书字数 words（只在读完时填一次）</label>
        <input id="bookFinishedWords" type="number" inputmode="numeric" min="0" placeholder="例如：32000" />
      </div>
    </div>

    <div class="btns">
      <button class="primary" id="btnSave">保存 / 更新</button>
      <button class="ghost" id="btnLoad">载入该日期</button>
      <button class="danger" id="btnClear">清空输入框</button>
    </div>

    <div id="msg" class="toast">不会打卡，只统计「有记录的天数」。</div>
  </section>

  <!-- 统计 -->
  <section class="card">
    <h2>统计 <span class="countBadge" id="countBadge">0 条</span></h2>

    <label>范围</label>
    <select id="range">
      <option value="month">本月</option>
      <option value="year">今年</option>
      <option value="all">全部</option>
    </select>

    <div class="backupBanner">
      备份提醒：建议每周导出一次 JSON（比如周日）。<br/>
      你更换设备/清理浏览器时，只有导出的备份能恢复数据。
    </div>

    <div class="statbox">
      <div class="pill"><span>累计单词</span><div class="val" id="sumWords">0</div></div>
      <div class="pill"><span>阅读（页 / 分）</span><div class="val"><span id="sumPages" style="font-weight:800;color:var(--text);">0</span> 页 · <span id="sumReadMin" style="font-weight:800;color:var(--text);">0</span> 分</div></div>
      <div class="pill"><span>听力（分钟）</span><div class="val" id="sumListenMin">0</div></div>
      <div class="pill"><span>总学习时长（读+听，分钟）</span><div class="val" id="sumStudyMin">0</div></div>
      <div class="pill"><span>累计天数（有记录）</span><div class="val" id="sumDays">0</div></div>
      <div class="pill"><span>已读书籍 words（读完累加）</span><div class="val" id="sumBookWords">0</div></div>
    </div>

    <div class="mini">
      <div class="chip">提示：天数=当天任一项>0 或有备注/听力内容/读完书</div>
      <div class="chip">提示：读完书 words 只在读完那天填一次</div>
    </div>

    <hr style="border:none;border-top:1px solid var(--border);margin:14px 0;"/>

    <h2 style="margin:0 0 10px;">历史记录</h2>
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th style="width:110px;">日期</th>
            <th>概要</th>
            <th class="right" style="width:88px;">操作</th>
          </tr>
        </thead>
        <tbody id="history"></tbody>
      </table>
    </div>

    <hr style="border:none;border-top:1px solid var(--border);margin:14px 0;"/>

    <h2 style="margin:0 0 10px;">备份 / 恢复</h2>
    <div class="btns">
      <button class="ghost" id="btnExport">导出 JSON</button>
      <button class="ghost" id="btnImport">导入 JSON</button>
      <input id="importFile" type="file" accept="application/json" style="display:none;">
    </div>
    <div class="hint">导出后保存到「文件」或 iCloud Drive。导入会覆盖当前数据（导入前建议先导出备份）。</div>
  </section>
</main>

<script>
(() => {
  // ====== 存储 key（尽量稳定，不因改代码清空）======
  const STORE_KEY = "sisi_en_study_log_v1";

  // ====== 工具 ======
  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2, "0");
  const todayISO = () => {
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  };
  const toInt = (v) => {
    const n = parseInt(String(v ?? "").trim(), 10);
    return Number.isFinite(n) && n > 0 ? n : 0;
  };
  const str = (v) => String(v ?? "").trim();
  const safeJSON = (s, fallback) => { try { return JSON.parse(s); } catch { return fallback; } };

  function readStore(){
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw){
      const init = { daily: {}, meta: { createdAt: Date.now() } };
      localStorage.setItem(STORE_KEY, JSON.stringify(init));
      return init;
    }
    const data = safeJSON(raw, { daily: {}, meta: {} });
    if(!data.daily) data.daily = {};
    return data;
  }
  function writeStore(data){
    localStorage.setItem(STORE_KEY, JSON.stringify(data));
  }

  function setMsg(text, type=""){
    const el = $("msg");
    el.textContent = text;
    el.className = "toast" + (type ? " " + type : "");
  }

  // ====== 生成一个简洁 favicon（SVG data url）======
  function setFavicon(){
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#4f46e5"/>
            <stop offset="1" stop-color="#06b6d4"/>
          </linearGradient>
        </defs>
        <rect x="0" y="0" width="128" height="128" rx="26" fill="url(#g)"/>
        <text x="64" y="58" text-anchor="middle" font-size="34" font-family="Arial" fill="white" font-weight="700">Sisi</text>
        <text x="64" y="94" text-anchor="middle" font-size="30" font-family="Arial" fill="white" font-weight="700">EN</text>
      </svg>`;
    const url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg.trim());
    $("favicon").href = url;
  }

  // ====== 读写表单 ======
  function getForm(){
    return {
      date: $("date").value,
      note: str($("note").value),

      enWords: toInt($("enWords").value),
      readPages: toInt($("readPages").value),
      readMinutes: toInt($("readMinutes").value),
      readTitle: str($("readTitle").value),

      listenWhat: str($("listenWhat").value),
      listenMinutes: toInt($("listenMinutes").value),

      bookFinishedTitle: str($("bookFinishedTitle").value),
      bookFinishedWords: toInt($("bookFinishedWords").value),
    };
  }

  function setForm(obj){
    $("note").value = obj.note || "";

    $("enWords").value = obj.enWords || "";
    $("readPages").value = obj.readPages || "";
    $("readMinutes").value = obj.readMinutes || "";
    $("readTitle").value = obj.readTitle || "";

    $("listenWhat").value = obj.listenWhat || "";
    $("listenMinutes").value = obj.listenMinutes || "";

    $("bookFinishedTitle").value = obj.bookFinishedTitle || "";
    $("bookFinishedWords").value = obj.bookFinishedWords || "";
  }

  function clearInputs(keepDate=true){
    const d = keepDate ? $("date").value : "";
    $("note").value = "";
    $("enWords").value = "";
    $("readPages").value = "";
    $("readMinutes").value = "";
    $("readTitle").value = "";
    $("listenWhat").value = "";
    $("listenMinutes").value = "";
    $("bookFinishedTitle").value = "";
    $("bookFinishedWords").value = "";
    if(keepDate) $("date").value = d;
  }

  function isActiveDay(rec){
    // 有任何学习数据/内容，即算一天
    return (
      (rec.enWords|0) > 0 ||
      (rec.readPages|0) > 0 ||
      (rec.readMinutes|0) > 0 ||
      (rec.listenMinutes|0) > 0 ||
      (rec.bookFinishedWords|0) > 0 ||
      str(rec.note).length > 0 ||
      str(rec.listenWhat).length > 0 ||
      str(rec.readTitle).length > 0 ||
      str(rec.bookFinishedTitle).length > 0
    );
  }

  // ====== 保存 / 载入 ======
  function saveForDate(){
    const f = getForm();
    if(!f.date){
      setMsg("请先选择日期。", "bad");
      return;
    }
    const store = readStore();
    store.daily[f.date] = {
      note: f.note,

      enWords: f.enWords,
      readPages: f.readPages,
      readMinutes: f.readMinutes,
      readTitle: f.readTitle,

      listenWhat: f.listenWhat,
      listenMinutes: f.listenMinutes,

      bookFinishedTitle: f.bookFinishedTitle,
      bookFinishedWords: f.bookFinishedWords,

      updatedAt: Date.now()
    };
    writeStore(store);
    setMsg("已保存 ✅", "ok");
    renderAll();
  }

  function loadForDate(){
    const d = $("date").value;
    if(!d){
      setMsg("请先选择日期。", "bad");
      return;
    }
    const store = readStore();
    const rec = store.daily[d];
    if(rec){
      setForm(rec);
      setMsg("已载入该日期记录。", "ok");
    }else{
      clearInputs(true);
      setMsg("该日期暂无记录，已清空输入框。", "ok");
    }
  }

  // ====== 统计 & 历史 ======
  function inRange(dateISO, mode){
    if(mode === "all") return true;
    const [y,m] = dateISO.split("-").map(Number);
    const now = new Date();
    const cy = now.getFullYear();
    const cm = now.getMonth()+1;
    if(mode === "year") return y === cy;
    if(mode === "month") return y === cy && m === cm;
    return true;
  }

  function buildSummary(dateISO, rec){
    const parts = [];
    const w = rec.enWords|0;
    const p = rec.readPages|0;
    const rm = rec.readMinutes|0;
    const lm = rec.listenMinutes|0;
    const bw = rec.bookFinishedWords|0;

    if(w) parts.push(`单词${w}`);
    if(p) parts.push(`阅读${p}页`);
    if(rm) parts.push(`读${rm}分`);
    if(lm) parts.push(`听${lm}分`);
    if(bw) parts.push(`读完+${bw} words`);

    if(parts.length === 0){
      if(str(rec.note)) parts.push(`备注：${rec.note}`);
      else parts.push("（空记录）");
    }
    return parts.join(" · ");
  }

  function calcStats(){
    const store = readStore();
    const mode = $("range").value;
    const daily = store.daily || {};
    const dates = Object.keys(daily).sort((a,b)=> b.localeCompare(a));

    let sumWords=0, sumPages=0, sumReadMin=0, sumListenMin=0, sumBookWords=0;
    let dayCount=0;
    let totalCount=0;

    for(const d of dates){
      const rec = daily[d] || {};
      if(!inRange(d, mode)) continue;

      totalCount++;
      sumWords += rec.enWords|0;
      sumPages += rec.readPages|0;
      sumReadMin += rec.readMinutes|0;
      sumListenMin += rec.listenMinutes|0;
      sumBookWords += rec.bookFinishedWords|0;
      if(isActiveDay(rec)) dayCount++;
    }

    return {
      dates, daily, mode,
      sumWords, sumPages, sumReadMin, sumListenMin,
      sumStudyMin: sumReadMin + sumListenMin,
      sumBookWords,
      dayCount,
      totalCount
    };
  }

  function renderStats(){
    const s = calcStats();
    $("sumWords").textContent = s.sumWords;
    $("sumPages").textContent = s.sumPages;
    $("sumReadMin").textContent = s.sumReadMin;
    $("sumListenMin").textContent = s.sumListenMin;
    $("sumStudyMin").textContent = s.sumStudyMin;
    $("sumBookWords").textContent = s.sumBookWords;
    $("sumDays").textContent = s.dayCount;
    $("countBadge").textContent = `${s.totalCount} 条`;
  }

  function renderHistory(){
    const { dates, daily, mode } = calcStats();
    const tbody = $("history");
    tbody.innerHTML = "";

    const filtered = dates.filter(d => inRange(d, mode));
    if(filtered.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="3" style="color:#64748b;">还没有记录。</td>`;
      tbody.appendChild(tr);
      return;
    }

    for(const d of filtered){
      const rec = daily[d] || {};
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d}</td>
        <td>${buildSummary(d, rec)}</td>
        <td class="right actions">
          <button data-edit="${d}">编辑</button>
          <button class="danger" data-del="${d}">删除</button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    tbody.querySelectorAll("button[data-edit]").forEach(btn=>{
      btn.addEventListener("click", () => {
        $("date").value = btn.getAttribute("data-edit");
        loadForDate();
        window.scrollTo({top:0, behavior:"smooth"});
      });
    });

    tbody.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.addEventListener("click", () => {
        const d = btn.getAttribute("data-del");
        if(!confirm(`确认删除 ${d} 这条记录？`)) return;
        const store = readStore();
        delete store.daily[d];
        writeStore(store);
        setMsg("已删除。", "ok");
        renderAll();
      });
    });
  }

  // ====== 备份 / 恢复 ======
  function exportJSON(){
    const data = readStore();
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `Sisi_English_Study_Log_${todayISO()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
    setMsg("已导出备份 JSON。", "ok");
  }

  function importJSON(file){
    const reader = new FileReader();
    reader.onload = () => {
      const obj = safeJSON(reader.result, null);
      if(!obj || typeof obj !== "object" || !obj.daily){
        setMsg("导入失败：JSON 格式不对。", "bad");
        return;
      }
      if(!confirm("导入会覆盖当前数据，确认继续？")) return;
      writeStore(obj);
      setMsg("导入成功 ✅", "ok");
      renderAll();
    };
    reader.readAsText(file);
  }

  function renderAll(){
    renderStats();
    renderHistory();
  }

  // ====== 事件绑定 ======
  $("btnSave").addEventListener("click", saveForDate);
  $("btnLoad").addEventListener("click", loadForDate);
  $("btnClear").addEventListener("click", () => {
    clearInputs(true);
    setMsg("已清空输入框。", "ok");
  });
  $("range").addEventListener("change", renderAll);

  $("btnExport").addEventListener("click", exportJSON);
  $("btnImport").addEventListener("click", ()=> $("importFile").click());
  $("importFile").addEventListener("change", (e)=>{
    const f = e.target.files && e.target.files[0];
    if(f) importJSON(f);
    e.target.value = "";
  });

  // ====== 初始化 ======
  setFavicon();
  $("date").value = todayISO();
  readStore(); // 确保存储存在
  renderAll();
})();
</script>

</body>
</html>