<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>è‹±è¯­å­¦ä¹ è®°å½•</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <style>
    :root{
      --bg:#0b1220;
      --card:#121b2f;
      --muted:#8ea0c7;
      --text:#e9efff;
      --accent:#6ea8fe;
      --danger:#ff6b6b;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
      background:linear-gradient(180deg,#070b14,#0b1220 45%,#070b14);
      color:var(--text);
    }
    header{
      padding:18px 16px 10px;
      position:sticky; top:0;
      backdrop-filter: blur(10px);
      background:rgba(11,18,32,.7);
      border-bottom:1px solid rgba(255,255,255,.06);
      z-index:2;
    }
    h1{ margin:0 0 6px; font-size:18px; }
    .sub{ color:var(--muted); font-size:12px; }

    main{ padding:14px 16px 40px; max-width:1040px; margin:0 auto; }
    .grid{ display:grid; grid-template-columns: 1.05fr .95fr; gap:12px; }
    @media (max-width:860px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:rgba(18,27,47,.85);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{ margin:0 0 10px; font-size:15px; }

    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input, textarea, select{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(7,11,20,.55);
      color:var(--text);
      outline:none;
    }
    textarea{ min-height:70px; resize:vertical; }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; align-items:end; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    @media (max-width:520px){ .row,.row3{ grid-template-columns:1fr; } }

    button{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(110,168,254,.18);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button:hover{ background:rgba(110,168,254,.26); }
    .danger{ background:rgba(255,107,107,.14); border-color:rgba(255,107,107,.35); }
    .danger:hover{ background:rgba(255,107,107,.22); }

    .btns{ display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
    .right{ text-align:right; }
    .small{ font-size:12px; color:var(--muted); }
    .hint{ font-size:12px; color:var(--muted); margin-top:10px; min-height:16px; }

    .divider{ height:1px; background:rgba(255,255,255,.08); margin:12px 0; }

    .stats{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:520px){ .stats{ grid-template-columns:1fr; } }
    .stat{
      border-radius:12px;
      padding:12px;
      background:rgba(7,11,20,.45);
      border:1px solid rgba(255,255,255,.08);
    }
    .stat .k{ font-size:12px; color:var(--muted); }
    .stat .v{ font-size:18px; margin-top:6px; }

    .pill{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      font-size:12px;
      background:rgba(110,168,254,.18);
      border:1px solid rgba(255,255,255,.10);
    }

    table{ width:100%; border-collapse: collapse; font-size:12px; }
    th, td{ padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); vertical-align: top; }
    th{ text-align:left; color:var(--muted); font-weight:600; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
  </style>
</head>

<body>
<header>
  <h1>è‹±è¯­å­¦ä¹ è®°å½•</h1>
  <div class="sub">æ¯æ—¥è®°å½• + å·²è¯»ä¹¦ç± wordsï¼ˆæ•°æ®ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ï¼›å»ºè®®æ¯å‘¨å¯¼å‡ºä¸€æ¬¡å¤‡ä»½ï¼‰</div>
</header>

<main class="grid">
  <!-- å·¦ï¼šæ¯æ—¥è®°å½• -->
  <section class="card">
    <h2>æ¯æ—¥è®°å½•</h2>

    <div class="row">
      <div>
        <label>æ—¥æœŸ</label>
        <input id="date" type="date" />
      </div>
      <div>
        <label>å¿«é€Ÿå¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
        <input id="note" placeholder="ä¾‹å¦‚ï¼šçŠ¶æ€ä¸€èˆ¬ï¼Œç¢ç‰‡æ—¶é—´å¤š" />
      </div>
    </div>

    <div class="divider"></div>

    <h2>è‹±è¯­</h2>
    <div class="row3">
      <div>
        <label>è‹±è¯­å•è¯ï¼ˆä¸ªï¼‰</label>
        <input id="enWords" type="number" min="0" inputmode="numeric" />
      </div>
      <div>
        <label>é˜…è¯»é¡µæ•°ï¼ˆé¡µï¼‰</label>
        <input id="readPages" type="number" min="0" inputmode="numeric" />
      </div>
      <div>
        <label>é˜…è¯»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
        <input id="readMinutes" type="number" min="0" inputmode="numeric" />
      </div>
    </div>

    <label>é˜…è¯»ä¹¦å</label>
    <input id="readTitle" placeholder="ä¾‹å¦‚ï¼šPax / Atomic Habits..." />

    <div class="row">
      <div>
        <label>å¬åŠ›å†…å®¹</label>
        <input id="listenTitle" placeholder="ä¾‹å¦‚ï¼šBBC / Podcast..." />
      </div>
      <div>
        <label>å¬åŠ›æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
        <input id="listenMinutes" type="number" min="0" inputmode="numeric" />
      </div>
    </div>

    <label>å½“æ—¥å­¦ä¹ å†…å®¹ï¼ˆå¯é€‰ï¼‰</label>
    <textarea id="detail" placeholder="ä¾‹å¦‚ï¼šWW3000 L5ï¼›BBC Easy English ä¸¤é›†"></textarea>

    <div class="btns">
      <button id="saveBtn" type="button">ä¿å­˜ / æ›´æ–°</button>
      <button id="loadTodayBtn" type="button">è½½å…¥è¯¥æ—¥æœŸ</button>
      <button id="clearFormBtn" class="danger" type="button">æ¸…ç©º</button>
    </div>

    <div class="hint" id="msg"></div>
  </section>

  <!-- å³ï¼šç»Ÿè®¡ + å·²è¯»ä¹¦ç± -->
  <aside class="card">
    <div class="row">
      <div>
        <h2 style="margin:0;">ç»Ÿè®¡</h2>
        <div class="small">èŒƒå›´ï¼š</div>
      </div>
      <div class="right">
        <select id="scope">
          <option value="month">æœ¬æœˆ</option>
          <option value="year">æœ¬å¹´</option>
          <option value="all">å…¨éƒ¨</option>
        </select>
      </div>
    </div>

    <div class="stats" id="stats"></div>

    <div class="divider"></div>

    <h2>è¯»å®Œä¸€æœ¬ä¹¦ï¼ˆè®°å½• wordsï¼‰</h2>
    <div class="row">
      <div>
        <label>ä¹¦å</label>
        <input id="bookTitle" placeholder="ä¾‹å¦‚ï¼šPax" />
      </div>
      <div>
        <label>Wordsï¼ˆé˜…è¯»è¥æä¾›ï¼‰</label>
        <input id="bookWords" type="number" min="0" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š56000" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>å®Œæˆæ—¥æœŸ</label>
        <input id="bookDate" type="date" />
      </div>
      <div class="right" style="align-self:end;">
        <button id="addBookBtn" type="button">æ·»åŠ å·²è¯»</button>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <h2 style="margin:0;">æ¯æ—¥è®°å½•å†å²</h2>
      <div class="right"><span class="pill" id="countPill">0 æ¡</span></div>
    </div>

    <div style="overflow:auto; max-height: 220px; margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th style="min-width:88px;">æ—¥æœŸ</th>
            <th>æ¦‚è¦</th>
            <th style="min-width:118px;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="list"></tbody>
      </table>
    </div>

    <div class="divider"></div>

    <div class="row">
      <h2 style="margin:0;">å·²è¯»ä¹¦ç±åˆ—è¡¨</h2>
      <div class="right"><span class="pill" id="bookCountPill">0 æœ¬</span></div>
    </div>

    <div style="overflow:auto; max-height: 220px; margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th style="min-width:92px;">å®Œæˆ</th>
            <th>ä¹¦å / words</th>
            <th style="min-width:118px;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="bookList"></tbody>
      </table>
    </div>

    <div class="divider"></div>

    <h2>å¤‡ä»½ / æ¢å¤</h2>
    <div class="btns">
      <button id="exportBtn" type="button">å¯¼å‡º JSON</button>
      <button id="importBtn" type="button">å¯¼å…¥ JSON</button>
    </div>
    <input id="fileInput" type="file" accept="application/json" style="display:none;" />
  </aside>
</main>

<script>
/***********************
 * FINAL JS for GitHub Pages
 * - English only (no Japanese)
 * - No punch-in; only "days with records"
 * - Finished books words add-on
 * - Backup reminder
 * - Stable localStorage keys + legacy migration
 ***********************/

// ====== Keys ======
const DAILY_KEY = "study_log_EN_MAIN";
const BOOK_KEY  = "study_books_EN_MAIN";
const BACKUP_META_KEY = "study_backup_meta_EN_v1";

// If you previously used CodePen versions, these help pull data back once:
const LEGACY_DAILY_KEYS = [
  "study_log_MAIN",
  "study_log_v1",
  "study_log_v2",
  "study_log_v3",
  "study_log_unified_v1",
  "study_log_unified_v2",
  "study_log_unified_v3",
  "study_log_v3_unified",
  "study_log_v3_unified_v3",
  "study_log_unified_v3_unified",
].filter((v,i,a)=>a.indexOf(v)===i);

const LEGACY_BOOK_KEYS = [
  "study_books_MAIN",
  "study_books_v1",
  "study_books_v2",
  "study_books_v3",
].filter((v,i,a)=>a.indexOf(v)===i);

// ====== Backup reminder settings ======
const REMIND_EVERY_CHANGES = 10; // å˜æ›´æ¬¡æ•°è¾¾åˆ°é˜ˆå€¼æé†’
const REMIND_IF_DAYS_OVER = 7;   // è·ç¦»ä¸Šæ¬¡å¤‡ä»½è¶…è¿‡Nå¤©æé†’

// ====== helpers ======
const $ = (id)=>document.getElementById(id);

function todayISO(){
  const d = new Date();
  const tz = d.getTimezoneOffset()*60000;
  return new Date(d - tz).toISOString().slice(0,10);
}

function toast(msg){
  const el = $("msg");
  if(!el) return;
  el.textContent = msg || "";
  if(msg) setTimeout(()=>{ if(el.textContent===msg) el.textContent=""; }, 1800);
}

function sval(id){ return ($(id)?.value || "").trim(); }
function setVal(id,v){ if($(id)) $(id).value = v ?? ""; }
function nval(id){
  const v = $(id)?.value;
  if(v === "" || v == null) return 0;
  const n = parseInt(v,10);
  return Number.isFinite(n) ? Math.max(0,n) : 0;
}
function fmtMin(min){
  min = Number(min||0);
  if(min<=0) return "0 åˆ†";
  const h = Math.floor(min/60), m = min%60;
  if(h<=0) return `${m} åˆ†`;
  if(m===0) return `${h} å°æ—¶`;
  return `${h} å°æ—¶ ${m} åˆ†`;
}
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, c=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

// ====== storage ======
function readJSON(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return fallback;
    return JSON.parse(raw);
  }catch{
    return fallback;
  }
}
function writeJSON(key, obj){
  // GitHub Pages normally stable; keep try/catch for safety
  try{
    localStorage.setItem(key, JSON.stringify(obj));
  }catch(e){
    toast("ä¿å­˜å¤±è´¥ï¼šæµè§ˆå™¨é™åˆ¶äº†æœ¬åœ°å­˜å‚¨ã€‚è¯·ç”¨ Safari æ­£å¸¸æ¨¡å¼æ‰“å¼€åå†æ·»åŠ åˆ°ä¸»å±å¹•ã€‚");
    console.log("localStorage setItem failed:", e);
    throw e;
  }
}

// ====== backup reminder meta ======
function readBackupMeta(){
  try { return JSON.parse(localStorage.getItem(BACKUP_META_KEY) || "{}"); }
  catch { return {}; }
}
function writeBackupMeta(meta){
  try{ localStorage.setItem(BACKUP_META_KEY, JSON.stringify(meta)); }catch{}
}
function markBackupDone(){
  const meta = readBackupMeta();
  meta.lastBackupAt = Date.now();
  meta.pendingChanges = 0;
  meta.lastRemindedAt = Date.now();
  writeBackupMeta(meta);
}
function recordChangeAndMaybeRemind(){
  const meta = readBackupMeta();
  meta.pendingChanges = Number(meta.pendingChanges || 0) + 1;

  const lastBackupAt = Number(meta.lastBackupAt || 0);
  const daysSinceBackup = lastBackupAt ? (Date.now()-lastBackupAt)/(1000*60*60*24) : 999;

  const shouldRemindByChanges = meta.pendingChanges >= REMIND_EVERY_CHANGES;
  const shouldRemindByDays = daysSinceBackup >= REMIND_IF_DAYS_OVER;

  const lastRemindedAt = Number(meta.lastRemindedAt || 0);
  const minutesSinceRemind = lastRemindedAt ? (Date.now()-lastRemindedAt)/(1000*60) : 999;

  if ((shouldRemindByChanges || shouldRemindByDays) && minutesSinceRemind >= 30) {
    toast(`å»ºè®®å¤‡ä»½ï¼šç‚¹â€œå¯¼å‡º JSONâ€ï¼ˆæœªå¤‡ä»½å˜æ›´ ${meta.pendingChanges} æ¬¡ï¼‰`);
    meta.lastRemindedAt = Date.now();
  }

  writeBackupMeta(meta);
}

// ====== migration ======
function migrateBestObjectIntoKey(targetKey, legacyKeys){
  const main = readJSON(targetKey, {});
  if(main && typeof main==="object" && Object.keys(main).length>0) return;

  let best=null, bestCount=0;
  for(const k of legacyKeys){
    const s = readJSON(k, {});
    const c = (s && typeof s==="object") ? Object.keys(s).length : 0;
    if(c>bestCount){ best=s; bestCount=c; }
  }
  if(best && bestCount>0) writeJSON(targetKey, best);
}
function migrateBestArrayIntoKey(targetKey, legacyKeys){
  const main = readJSON(targetKey, []);
  if(Array.isArray(main) && main.length>0) return;

  let best=null, bestCount=0;
  for(const k of legacyKeys){
    const s = readJSON(k, []);
    const c = Array.isArray(s) ? s.length : 0;
    if(c>bestCount){ best=s; bestCount=c; }
  }
  if(Array.isArray(best) && bestCount>0) writeJSON(targetKey, best);
}

// ====== stores ======
function readDaily(){
  migrateBestObjectIntoKey(DAILY_KEY, LEGACY_DAILY_KEYS);
  return readJSON(DAILY_KEY, {});
}
function writeDaily(store){
  writeJSON(DAILY_KEY, store);
  try{ recordChangeAndMaybeRemind(); }catch{}
}
function readBooks(){
  migrateBestArrayIntoKey(BOOK_KEY, LEGACY_BOOK_KEYS);
  return readJSON(BOOK_KEY, []);
}
function writeBooks(list){
  writeJSON(BOOK_KEY, list);
  try{ recordChangeAndMaybeRemind(); }catch{}
}

// ====== form ======
function getDailyForm(){
  return {
    date: sval("date"),
    note: sval("note"),
    enWords: nval("enWords"),
    readTitle: sval("readTitle"),
    readPages: nval("readPages"),
    readMinutes: nval("readMinutes"),
    listenTitle: sval("listenTitle"),
    listenMinutes: nval("listenMinutes"),
    detail: sval("detail"),
    updatedAt: new Date().toISOString(),
  };
}
function setDailyForm(r){
  setVal("note", r?.note ?? "");
  setVal("enWords", r?.enWords ? r.enWords : "");
  setVal("readTitle", r?.readTitle ?? "");
  setVal("readPages", r?.readPages ? r.readPages : "");
  setVal("readMinutes", r?.readMinutes ? r.readMinutes : "");
  setVal("listenTitle", r?.listenTitle ?? "");
  setVal("listenMinutes", r?.listenMinutes ? r.listenMinutes : "");
  setVal("detail", r?.detail ?? "");
}

let __isClearing=false;
function clearDailyKeepDate(showToast=true){
  __isClearing=true;
  const keep=sval("date");

  ["note","enWords","readTitle","readPages","readMinutes","listenTitle","listenMinutes","detail"]
    .forEach(id=>{ if($(id)) $(id).value=""; });

  setVal("date", keep);
  setTimeout(()=>__isClearing=false, 200);
  if(showToast) toast("å·²æ¸…ç©º");
}

// ====== scope ======
function scopeInfo(){
  const scope = $("scope")?.value || "month";
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,"0");
  return { scope, prefixMonth:`${y}-${m}-`, prefixYear:`${y}-` };
}
function filterDailyByScope(store){
  const {scope,prefixMonth,prefixYear}=scopeInfo();
  const out={};
  for(const [date,rec] of Object.entries(store)){
    if(scope==="all") out[date]=rec;
    else if(scope==="month" && date.startsWith(prefixMonth)) out[date]=rec;
    else if(scope==="year" && date.startsWith(prefixYear)) out[date]=rec;
  }
  return out;
}
function filterBooksByScope(books){
  const {scope,prefixMonth,prefixYear}=scopeInfo();
  if(scope==="all") return books;
  if(scope==="month") return books.filter(b=>(b.finishedDate||"").startsWith(prefixMonth));
  return books.filter(b=>(b.finishedDate||"").startsWith(prefixYear));
}

// ====== CRUD daily ======
function saveDaily(){
  const rec = getDailyForm();
  if(!rec.date){ toast("è¯·é€‰æ‹©æ—¥æœŸ"); return; }

  const store = readDaily();
  store[rec.date]=rec;

  try{ writeDaily(store); }catch{ return; }
  renderAll();
  toast("å·²ä¿å­˜");
}
function loadDailyByDate(date){
  if(!date) return;
  const store = readDaily();
  const rec = store[date];
  if(rec){
    setDailyForm(rec);
    toast("å·²è½½å…¥è¯¥æ—¥æœŸ");
  }else{
    toast("è¯¥æ—¥æœŸæš‚æ— è®°å½•");
  }
}
function deleteDaily(date){
  const store = readDaily();
  if(!store[date]) return;
  delete store[date];

  try{ writeDaily(store); }catch{ return; }

  if(sval("date")===date) clearDailyKeepDate(false);
  renderAll();
  toast("å·²åˆ é™¤");
}
function editDaily(date){
  setVal("date", date);
  const store = readDaily();
  if(store[date]) setDailyForm(store[date]);
  window.scrollTo({top:0, behavior:"smooth"});
}

// ====== books ======
function addFinishedBook(){
  const title = sval("bookTitle");
  const words = nval("bookWords");
  const finished = sval("bookDate") || todayISO();
  if(!title || words<=0){ toast("è¯·å¡«å†™ä¹¦åå’Œ words"); return; }

  const books = readBooks();
  const id = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
  books.push({id, title, words, finishedDate: finished});

  try{ writeBooks(books); }catch{ return; }

  setVal("bookTitle","");
  setVal("bookWords","");
  setVal("bookDate", finished);

  renderAll();
  toast("å·²æ·»åŠ å·²è¯»");
}
function deleteBook(id){
  const books = readBooks().filter(b=>b.id!==id);
  try{ writeBooks(books); }catch{ return; }
  renderAll();
  toast("å·²åˆ é™¤");
}

// ====== render ======
function summarizeDaily(r){
  const parts=[];
  if(r.enWords) parts.push(`è‹±è¯ ${r.enWords}`);
  if(r.readPages || r.readMinutes) parts.push(`é˜…è¯» ${r.readPages}é¡µ/${r.readMinutes}åˆ†`);
  if(r.listenMinutes) parts.push(`å¬åŠ› ${r.listenMinutes}åˆ†`);
  return parts.join(" Â· ") || (r.note ? `å¤‡æ³¨ï¼š${r.note}` : "ï¼ˆæ— æ•°æ®ï¼‰");
}

function renderStats(dailyFiltered, booksFiltered){
  const days = Object.keys(dailyFiltered).length;

  let enWords=0, readPages=0, readMin=0, listenMin=0;
  for(const r of Object.values(dailyFiltered)){
    enWords += Number(r.enWords||0);
    readPages += Number(r.readPages||0);
    readMin += Number(r.readMinutes||0);
    listenMin += Number(r.listenMinutes||0);
  }
  const totalMin = readMin + listenMin;

  const booksCount = booksFiltered.length;
  const booksWords = booksFiltered.reduce((s,b)=>s+Number(b.words||0),0);

  const box=$("stats");
  if(!box) return;

  box.innerHTML = `
    <div class="stat">
      <div class="k">æ¯æ—¥è®°å½•ç´¯è®¡ï¼ˆæ‰€é€‰èŒƒå›´ï¼‰</div>
      <div class="v" style="font-size:14px; line-height:1.65;">
        è‹±è¯­å•è¯ï¼š<b>${enWords}</b><br/>
        é˜…è¯»ï¼š<b>${readPages}</b> é¡µ Â· <b>${fmtMin(readMin)}</b><br/>
        å¬åŠ›ï¼š<b>${fmtMin(listenMin)}</b><br/>
        è‹±è¯­æ€»æ—¶é•¿ï¼š<b>${fmtMin(totalMin)}</b>
      </div>
    </div>

    <div class="stat">
      <div class="k">å¤©æ•°ï¼ˆæ‰€é€‰èŒƒå›´ï¼‰</div>
      <div class="v" style="font-size:14px; line-height:1.65;">
        æœ‰è®°å½•ï¼š<b>${days}</b> å¤©
      </div>
    </div>

    <div class="stat">
      <div class="k">å·²è¯»ä¹¦ç±ç´¯è®¡ï¼ˆæŒ‰å®Œæˆæ—¥æœŸï¼‰</div>
      <div class="v" style="font-size:14px; line-height:1.65;">
        æœ¬æ•°ï¼š<b>${booksCount}</b><br/>
        Wordsï¼š<b>${booksWords.toLocaleString()}</b>
      </div>
    </div>
  `;
}

function renderDailyList(dailyFiltered){
  const tbody=$("list");
  if(!tbody) return;

  tbody.innerHTML="";
  const dates = Object.keys(dailyFiltered).sort((a,b)=>b.localeCompare(a));
  if($("countPill")) $("countPill").textContent = `${dates.length} æ¡`;

  if(!dates.length){
    tbody.innerHTML = `<tr><td colspan="3" style="color:#8ea0c7;">è¿˜æ²¡æœ‰è®°å½•ã€‚</td></tr>`;
    return;
  }

  for(const d of dates){
    const r = dailyFiltered[d];
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><strong>${d}</strong></td>
      <td>
        ${escapeHtml(summarizeDaily(r))}<br/>
        ${r.readTitle ? `<span style="color:#8ea0c7;">ğŸ“˜ ${escapeHtml(r.readTitle)}</span><br/>` : ""}
        ${r.listenTitle ? `<span style="color:#8ea0c7;">ğŸ§ ${escapeHtml(r.listenTitle)}</span>` : ""}
      </td>
      <td>
        <div class="actions">
          <button data-edit="${d}" type="button">ç¼–è¾‘</button>
          <button data-del="${d}" class="danger" type="button">åˆ é™¤</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  }

  tbody.onclick = (e)=>{
    const t = e.target;
    if(!(t instanceof HTMLElement)) return;
    const ed=t.getAttribute("data-edit");
    const del=t.getAttribute("data-del");
    if(ed) editDaily(ed);
    if(del) deleteDaily(del);
  };
}

function renderBookList(booksFiltered){
  const tbody=$("bookList");
  if(!tbody) return;

  tbody.innerHTML="";
  const sorted=[...booksFiltered].sort((a,b)=>(b.finishedDate||"").localeCompare(a.finishedDate||""));
  if($("bookCountPill")) $("bookCountPill").textContent = `${sorted.length} æœ¬`;

  if(!sorted.length){
    tbody.innerHTML = `<tr><td colspan="3" style="color:#8ea0c7;">è¿˜æ²¡æœ‰æ·»åŠ å·²è¯»ä¹¦ç±ã€‚</td></tr>`;
    return;
  }

  for(const b of sorted){
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td><strong>${escapeHtml(b.finishedDate||"")}</strong></td>
      <td>
        ${escapeHtml(b.title)}<br/>
        <span style="color:#8ea0c7;">${Number(b.words||0).toLocaleString()} words</span>
      </td>
      <td>
        <button data-bdel="${b.id}" class="danger" type="button">åˆ é™¤</button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  tbody.onclick = (e)=>{
    const t=e.target;
    if(!(t instanceof HTMLElement)) return;
    const id=t.getAttribute("data-bdel");
    if(id) deleteBook(id);
  };
}

function renderAll(){
  const daily = readDaily();
  const books = readBooks();
  const dailyFiltered = filterDailyByScope(daily);
  const booksFiltered = filterBooksByScope(books);

  renderStats(dailyFiltered, booksFiltered);
  renderDailyList(dailyFiltered);
  renderBookList(booksFiltered);
}

// ====== backup ======
function exportAll(){
  const payload = {
    version: 1,
    exportedAt: new Date().toISOString(),
    daily: readDaily(),
    books: readBooks(),
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `study_english_backup_${todayISO()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast("å·²å¯¼å‡º");
  markBackupDone();
}

function importAll(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const data = JSON.parse(reader.result);
      if(!data || typeof data!=="object"){ toast("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶å†…å®¹ä¸å¯¹"); return; }

      if(data.daily && typeof data.daily==="object"){
        const cur = readDaily();
        const merged = {...cur, ...data.daily};
        try{ writeDaily(merged); }catch{ return; }
      }
      if(Array.isArray(data.books)){
        const curB = readBooks();
        const map = new Map(curB.map(x=>[x.id, x]));
        for(const b of data.books){
          if(b && b.id) map.set(b.id, b);
        }
        try{ writeBooks([...map.values()]); }catch{ return; }
      }

      renderAll();
      toast("å·²å¯¼å…¥");
      markBackupDone();
    }catch(e){
      console.log(e);
      toast("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸å¯¹");
    }
  };
  reader.readAsText(file);
}

// ====== init ======
function init(){
  setVal("date", sval("date") || todayISO());
  setVal("bookDate", sval("bookDate") || todayISO());

  $("saveBtn")?.addEventListener("click", saveDaily);
  $("loadTodayBtn")?.addEventListener("click", ()=>{ const d=sval("date"); if(d) loadDailyByDate(d); });
  $("clearFormBtn")?.addEventListener("click", ()=>clearDailyKeepDate(true));

  $("date")?.addEventListener("change", ()=>{
    if(__isClearing) return;
    const d=sval("date");
    if(d) loadDailyByDate(d); // æ— è®°å½•åˆ™æç¤ºï¼Œä¸æ¸…ç©º
  });

  $("scope")?.addEventListener("change", renderAll);
  $("addBookBtn")?.addEventListener("click", addFinishedBook);

  $("exportBtn")?.addEventListener("click", exportAll);
  $("importBtn")?.addEventListener("click", ()=>$("fileInput")?.click());
  $("fileInput")?.addEventListener("change", (e)=>{
    const f=e.target.files?.[0];
    if(f) importAll(f);
    e.target.value="";
  });

  renderAll();

  // If today has record, load into form (quietly)
  const d=sval("date");
  const store=readDaily();
  if(store[d]) setDailyForm(store[d]);
}
init();
</script>
</body>
</html>