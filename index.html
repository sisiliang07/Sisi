<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>è‹±è¯­å­¦ä¹ è®°å½•ï¼ˆSisiï¼‰</title>

  <!-- PWA / iOS -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icon-512.png">
  <meta name="theme-color" content="#f6f7ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    :root{
      --bg:#f6f7ff;
      --panel:#ffffff;
      --panel2:#fbfbff;
      --text:#101828;
      --muted:#667085;
      --border:#e6e8f0;
      --shadow: 0 14px 40px rgba(16,24,40,.10);
      --shadow2: 0 8px 18px rgba(16,24,40,.08);
      --accent:#4f46e5;
      --accent2:#2563eb;
      --danger:#ef4444;
      --ok:#16a34a;
      --warn:#f59e0b;
      --radius:16px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 50% -200px, rgba(79,70,229,.14), transparent 60%),
        radial-gradient(900px 500px at 10% 20%, rgba(37,99,235,.10), transparent 55%),
        radial-gradient(900px 500px at 90% 35%, rgba(99,102,241,.10), transparent 55%),
        var(--bg);
    }

    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter:saturate(180%) blur(16px);
      background:rgba(246,247,255,.82);
      border-bottom:1px solid rgba(230,232,240,.9);
      padding:18px 16px 10px;
    }
    h1{ margin:0 0 6px; font-size:20px; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:12px; line-height:1.35; }

    main{
      max-width:980px;
      margin:0 auto;
      padding:14px 16px 44px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow2);
      padding:14px;
    }
    .card h2{
      margin:0 0 12px;
      font-size:18px;
      letter-spacing:.2px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .row{ grid-template-columns:1fr; }
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:10px 0 6px;
    }

    input, textarea, select{
      width:100%;
      border:1px solid var(--border);
      background:var(--panel2);
      color:var(--text);
      border-radius:14px;
      padding:12px 12px;
      font-size:14px;
      outline:none;
      box-shadow: inset 0 1px 0 rgba(16,24,40,.02);
    }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(79,70,229,.45);
      box-shadow: 0 0 0 4px rgba(79,70,229,.10);
      background:#fff;
    }
    textarea{ min-height:86px; resize:vertical; }

    /* ä¿®å¤ iOS æ—¥æœŸè¾“å…¥æ¡†æ˜¾ç¤ºå¼‚å¸¸ */
    input[type="date"]{
      -webkit-appearance:none;
      appearance:none;
      text-align:left;
      padding:12px 12px;
      height:46px;
      line-height:22px;
    }
    input[type="date"]::-webkit-date-and-time-value{ text-align:left; }
    input[type="date"]::-webkit-calendar-picker-indicator{ opacity:.65; }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    button{
      border:1px solid var(--border);
      background: #ffffff;
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-size:14px;
      box-shadow: var(--shadow2);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{ transform: translateY(1px); }
    .btnPrimary{
      border-color: rgba(79,70,229,.22);
      background: linear-gradient(180deg, rgba(79,70,229,.98), rgba(37,99,235,.98));
      color:#fff;
    }
    .btnSoft{
      border-color: rgba(79,70,229,.18);
      background: rgba(79,70,229,.06);
      color: #2b2b70;
    }
    .btnDanger{
      border-color: rgba(239,68,68,.24);
      background: rgba(239,68,68,.08);
      color:#7a1f1f;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:12px;
      color:var(--muted);
    }

    .hr{
      height:1px; background:var(--border);
      margin:14px 0;
    }

    .kpi{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width:520px){ .kpi{ grid-template-columns:1fr; } }
    .kpiBox{
      background:#fff;
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      box-shadow: var(--shadow2);
    }
    .kpiBox .t{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    .kpiBox .v{ font-size:18px; font-weight:650; }

    .kpiGrid{ display:flex; flex-direction:column; gap:10px; margin-top:6px; }
    .kpiRow{ display:flex; align-items:baseline; justify-content:space-between; gap:12px; }
    .kpiL{ color:#6b7280; font-size:14px; }
    .kpiR{ color:#111827; font-weight:650; font-size:14px; text-align:right; white-space:nowrap; }
    .kpiRBig{ font-size:18px; }

    /* History table: make Summary wider by shrinking Action column */
    th:last-child, td:last-child{ width:92px; min-width:92px; }
    th:last-child{ text-align:right; padding-right:22px; }
    td:last-child{ padding-left:8px; padding-right:8px; }
    td:last-child .actions{ display:flex; flex-direction:column; gap:10px; align-items:center; justify-content:center; }
    /* Smaller action buttons so Summary column has more room */
    td:last-child .actions .mini{ width:66px; min-width:66px; padding:8px 0; line-height:1.1; }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:13px;
      overflow:hidden;
    }
    th, td{
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      vertical-align:top;
    }
    th{
      font-size:12px;
      color:var(--muted);
      font-weight:600;
      background: rgba(246,247,255,.75);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .actions{ display:flex; gap:10px; flex-direction:column; align-items:center; justify-content:center; }
    td:last-child{ vertical-align:middle; text-align:center; }
    td:last-child .actions .mini{ min-width:66px; }
    .mini{
      padding:7px 10px;
      border-radius:12px;
      font-size:13px;
      box-shadow:none;
    }

    /* Summary: one category per line */
    .summaryLines{ display:flex; flex-direction:column; gap:10px; }
    .sumLine{ line-height:1.15; }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: rgba(16,24,40,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      box-shadow: 0 10px 30px rgba(16,24,40,.25);
      display:none;
      z-index:999;
      max-width: calc(100% - 24px);
      text-align:center;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      line-height:1.45;
    }

    .banner{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(245,158,11,.28);
      background: rgba(245,158,11,.10);
      color:#7a4a00;
      font-size:12px;
      display:none;
    }
    .banner strong{ font-weight:700; }
  </style>
</head>

<body>
  <header>
    <h1>è‹±è¯­å­¦ä¹ è®°å½•ï¼ˆSisiï¼‰</h1>
    <div class="sub">æ¯æ—¥è®°å½• + ç»Ÿè®¡ + å·²è¯»ä¹¦ç± wordsï¼ˆæ•°æ®ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ï¼›å»ºè®®æ¯å‘¨å¯¼å‡ºä¸€æ¬¡å¤‡ä»½ï¼‰</div>
    <div class="banner" id="backupBanner"></div>
  </header>

  <main class="grid">
    <!-- ä»Šæ—¥è®°å½• -->
    <section class="card">
      <h2>æ¯æ—¥è®°å½•</h2>

      <div class="row">
        <div>
          <label>æ—¥æœŸ</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label>å¿«é€Ÿå¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
          <input id="note" placeholder="ä¾‹å¦‚ï¼šçŠ¶æ€ä¸€èˆ¬ã€ç¢ç‰‡æ—¶é—´å¤š" />
        </div>
      </div>

      <div class="hr"></div>

      <div>
        <h3 style="margin:0 0 6px;font-size:16px;">è‹±è¯­</h3>

        <label>è‹±è¯­å•è¯ï¼ˆä¸ªï¼‰</label>
        <input id="enWords" type="number" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š120" />

        <label>é˜…è¯»é¡µæ•°ï¼ˆé¡µï¼‰</label>
        <input id="readPages" type="number" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š12" />

        <label>é˜…è¯»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
        <input id="readMin" type="number" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š40" />

        <label>é˜…è¯»ä¹¦åï¼ˆå¯é€‰ï¼‰</label>
        <input id="readBook" placeholder="ä¾‹å¦‚ï¼šBE &amp; Court" />

        <label>å¬åŠ›å†…å®¹ï¼ˆå¯é€‰ï¼Œå¤šè¡Œï¼‰</label>
        <textarea id="listenText" placeholder="ä¾‹å¦‚ï¼šBBC Easy English&#10;æˆ–è€…ï¼š6 Minute English"></textarea>

        <div class="row">
          <div>
            <label>ç²¾å¬æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
            <input id="listenMin" type="number" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š30" />
          </div>
          <div>
            <label>æ³›å¬æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
            <input id="listenWideMin" type="number" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š20" />
          </div>
        </div>
      </div>

      <div class="btnRow">
        <button class="btnPrimary" id="saveBtn">ä¿å­˜ / æ›´æ–°</button>
        <button class="btnSoft" id="loadBtn">è½½å…¥è¯¥æ—¥æœŸ</button>
        <button class="btnDanger" id="clearBtn">æ¸…ç©º</button>
      </div>

      <div class="hint">
        å°æç¤ºï¼š<span class="pill">â€œè½½å…¥è¯¥æ—¥æœŸâ€</span> ä¼šæŠŠé‚£å¤©å·²ä¿å­˜çš„æ•°æ®å¡«å›è¡¨å•ï¼›<span class="pill">â€œæ¸…ç©ºâ€</span> åªæ¸…ç©ºå½“å‰è¡¨å•ï¼Œä¸ä¼šåˆ é™¤å†å²ã€‚
      </div>
    </section>

    <!-- ç»Ÿè®¡ / å¤‡ä»½ -->
    <section class="card">
      <h2>ç»Ÿè®¡</h2>

      <label>èŒƒå›´</label>
      <select id="range">
        <option value="month">æœ¬æœˆ</option>
        <option value="year">æœ¬å¹´</option>
        <option value="all">å…¨éƒ¨</option>
      </select>

      <div class="hr"></div>

      <div class="kpi">
        <div class="kpiBox">
          <div class="t">ç´¯è®¡ï¼ˆæ‰€é€‰èŒƒå›´ï¼‰</div>
          <div class="kpiGrid">
            <div class="kpiRow">
              <div class="kpiL">è‹±è¯­å•è¯</div>
              <div class="kpiR" id="kpiWords">0</div>
            </div>
            <div class="kpiRow">
              <div class="kpiL">é˜…è¯»</div>
              <div class="kpiR" id="kpiRead">0 é¡µ Â· 0 åˆ†</div>
            </div>
            <div class="kpiRow">
              <div class="kpiL">å¬åŠ›</div>
              <div class="kpiR" id="kpiListen">ç²¾å¬ 0 åˆ† Â· æ³›å¬ 0 åˆ†</div>
            </div>
          </div>
        </div>

        <div class="kpiBox">
          <div class="t">æ€»å­¦ä¹ æ—¶é•¿ï¼ˆæ‰€é€‰èŒƒå›´ï¼‰</div>
          <div class="v" id="kpiTime">0 åˆ†</div>
          <div class="hint">= é˜…è¯» + ç²¾å¬ + æ³›å¬</div>
        </div>

        <div class="kpiBox">
          <div class="t">ç´¯è®¡å¤©æ•°ï¼ˆæ‰€é€‰èŒƒå›´ï¼‰</div>
          <div class="v" id="kpiDays">æ€»è®¡ï¼š0 å¤©</div>
          <div class="hint" id="kpiDays2">æœ‰è‹±è¯­è®°å½•ï¼š0 å¤©</div>
        </div>

        <div class="kpiBox">
          <div class="t">å·²è¯»ä¹¦ç± wordsï¼ˆæ‰‹åŠ¨åŠ ï¼‰</div>
          <div class="v" id="kpiBookWords">0 words</div>
          <div class="hint">é€‚åˆâ€œè¯»å®Œä¸€æœ¬å†åŠ ä¸€æ¬¡â€ï¼Œä¸éœ€è¦æ¯å¤©ç®—ã€‚</div>
        </div>
      </div>

      <div class="hr"></div>

      <h2 style="margin-top:0;">å†å²è®°å½• <span class="pill" id="countPill">0 æ¡</span></h2>

      <div style="max-height:360px; overflow:auto; border:1px solid var(--border); border-radius:16px;">
        <table>
          <thead>
            <tr>
              <th style="width:110px;">æ—¥æœŸ</th>
              <th>æ‘˜è¦</th>
              <th style="width:150px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <tr><td colspan="3" style="color:var(--muted);">è¿˜æ²¡æœ‰è®°å½•ã€‚</td></tr>
          </tbody>
        </table>
      </div>

      <div class="hr"></div>

      <h2 style="margin-top:0;">å¤‡ä»½ / æ¢å¤</h2>
      <div class="btnRow">
        <button class="btnSoft" id="exportBtn">å¯¼å‡º JSON</button>
        <button class="btnSoft" id="importBtn">å¯¼å…¥ JSON</button>
        <input id="importFile" type="file" accept="application/json" style="display:none;" />
      </div>
      <div class="hint">
        å»ºè®®ï¼šæ¯å‘¨å¯¼å‡ºä¸€æ¬¡ JSON åˆ°ã€Œæ–‡ä»¶/iCloud/ç½‘ç›˜ã€ã€‚<br/>
        è¯´æ˜ï¼šGitHub Pages ä¸ä¼šè‡ªåŠ¨äº‘åŒæ­¥ï¼›ä¸åŒè®¾å¤‡/ä¸åŒæµè§ˆå™¨çš„æ•°æ®ä¸ä¼šè‡ªåŠ¨äº’é€šã€‚
      </div>

      <div class="hr"></div>

      <h2 style="margin-top:0;">å·²è¯»ä¹¦ç± words</h2>
      <label>ä¹¦å</label>
      <input id="bookTitle" placeholder="ä¾‹å¦‚ï¼šAtomic Habits" />
      <label>å­—æ•° / wordsï¼ˆæ•´æ•°ï¼‰</label>
      <input id="bookWords" type="number" inputmode="numeric" placeholder="ä¾‹å¦‚ï¼š70000" />
      <div class="btnRow">
        <button class="btnPrimary" id="addBookBtn">æ·»åŠ  / æ›´æ–°è¿™æœ¬</button>
        <button class="btnDanger" id="clearBookBtn">æ¸…ç©ºè¾“å…¥</button>
      </div>
      <div class="hint" id="bookHint"></div>
    </section>
  </main>

  <div class="toast" id="toast"></div>

  <script>

    /**********************
     * Storage (versioned)
     **********************/
    const APP_KEY = "sisi_en_study_log_v3"; // æ”¹ç‰ˆä¸æ”¹ keyï¼Œæ•°æ®ä¸ä¼šå› æ›´æ–°ä¸¢å¤±
    const DAYS_BACKUP_KEY = "sisi_en_last_backup_at";

    function readStore(){
      try{
        const raw = localStorage.getItem(APP_KEY);
        if(!raw) return { daily:{}, books:{} };
        const obj = JSON.parse(raw);
        if(!obj.daily) obj.daily = {};
        if(!obj.books) obj.books = {};
        return obj;
      }catch(e){
        return { daily:{}, books:{} };
      }
    }
    function writeStore(store){
      localStorage.setItem(APP_KEY, JSON.stringify(store));
    }

    function isoToday(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function inRange(iso, mode){
      if(mode === "all") return true;
      const [y,m] = iso.split("-").map(Number);
      const now = new Date();
      const ny = now.getFullYear();
      const nm = now.getMonth()+1;
      if(mode === "year") return y === ny;
      if(mode === "month") return (y === ny && m === nm);
      return true;
    }
    function num(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }

    function toast(msg){
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>{ el.style.display="none"; }, 1800);
    }

    /**********************
     * Elements
     **********************/
    const $ = (id)=>document.getElementById(id);

    const dateEl = $("date");
    const noteEl = $("note");

    const enWordsEl = $("enWords");
    const readPagesEl = $("readPages");
    const readMinEl = $("readMin");
    const readBookEl = $("readBook");
    const listenTextEl = $("listenText");
    const listenMinEl = $("listenMin");          // ç²¾å¬ï¼ˆåŸå­—æ®µï¼‰
    const listenWideMinEl = $("listenWideMin");  // æ³›å¬ï¼ˆæ–°å¢ï¼‰

    const rangeEl = $("range");

    /**********************
     * Form helpers
     **********************/
    function clearForm(){
      // åªæ¸…ç©ºè¡¨å•ï¼Œä¸åˆ å†å²
      noteEl.value = "";
      enWordsEl.value = "";
      readPagesEl.value = "";
      readMinEl.value = "";
      readBookEl.value = "";
      listenTextEl.value = "";
      listenMinEl.value = "";
      listenWideMinEl.value = "";
      toast("å·²æ¸…ç©ºè¡¨å•");
    }

    function setFormFromRecord(r){
      noteEl.value = r.note || "";
      enWordsEl.value = (r.enWords ?? "") === 0 ? 0 : (r.enWords ?? "");
      readPagesEl.value = (r.readPages ?? "") === 0 ? 0 : (r.readPages ?? "");
      readMinEl.value = (r.readMin ?? "") === 0 ? 0 : (r.readMin ?? "");
      readBookEl.value = r.readBook || "";
      listenTextEl.value = r.listenText || "";
      listenMinEl.value = (r.listenMin ?? "") === 0 ? 0 : (r.listenMin ?? "");
      listenWideMinEl.value = (r.listenWideMin ?? "") === 0 ? 0 : (r.listenWideMin ?? "");
    }

    function getRecordFromForm(){
      const date = dateEl.value || isoToday();
      return {
        date,
        note: noteEl.value.trim(),
        enWords: num(enWordsEl.value),
        readPages: num(readPagesEl.value),
        readMin: num(readMinEl.value),
        readBook: readBookEl.value.trim(),
        listenText: listenTextEl.value.trim(),
        listenMin: num(listenMinEl.value),              // ç²¾å¬ï¼ˆåŸé€»è¾‘ï¼‰
        listenWideMin: num(listenWideMinEl.value)       // æ³›å¬ï¼ˆæ–°å¢ï¼‰
      };
    }

    // History summary: one line per category (read / deep / broad)
    function summaryHTML(r){
      const lines = [];
      if(r.enWords) lines.push(`å•è¯${r.enWords}`);
      if(r.readPages || r.readMin){
        if(r.readPages && r.readMin) lines.push(`é˜…è¯»${r.readPages}é¡µ Â· ${r.readMin}åˆ†`);
        else if(r.readPages) lines.push(`é˜…è¯»${r.readPages}é¡µ`);
        else lines.push(`é˜…è¯»${r.readMin}åˆ†`);
      }
      if(r.listenMin) lines.push(`ç²¾å¬${r.listenMin}åˆ†`);
      if(r.listenWideMin) lines.push(`æ³›å¬${r.listenWideMin}åˆ†`);
      if(!lines.length) lines.push("ï¼ˆç©ºï¼‰");
      return lines.map(s => `<div class="sumLine">${escapeHtml(s)}</div>`).join("");
    }

    /**********************
     * Render: history + stats
     **********************/
    function render(){
      const store = readStore();
      const daily = store.daily || {};
      const keys = Object.keys(daily).sort((a,b)=> b.localeCompare(a));
      $("countPill").textContent = `${keys.length} æ¡`;

      // History table
      const tb = $("historyBody");
      tb.innerHTML = "";
      if(keys.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="3" style="color:var(--muted);">è¿˜æ²¡æœ‰è®°å½•ã€‚</td>`;
        tb.appendChild(tr);
      }else{
        for(const k of keys){
          const r = daily[k];
          const tr = document.createElement("tr");
          const safeDate = k;
          const safeSumHTML = summaryHTML(r);
          tr.innerHTML = `
            <td>${safeDate}</td>
            <td><div class="summaryLines">${safeSumHTML}</div>${r.note ? `<div style="color:var(--muted);margin-top:6px;">ğŸ“ ${escapeHtml(r.note)}</div>` : ""}</td>
            <td>
              <div class="actions">
                <button class="mini btnSoft" data-act="edit" data-date="${safeDate}">ç¼–è¾‘</button>
                <button class="mini btnDanger" data-act="del" data-date="${safeDate}">åˆ é™¤</button>
              </div>
            </td>
          `;
          tb.appendChild(tr);
        }
      }

      // Stats
      const mode = rangeEl.value;
      let totalWords=0, totalPages=0, totalReadMin=0, totalListenMin=0, totalListenWide=0;
      let anyDays=0, enDays=0;

      for(const k of Object.keys(daily)){
        if(!inRange(k, mode)) continue;
        const r = daily[k] || {};
        const hasAny = (num(r.enWords)+num(r.readPages)+num(r.readMin)+num(r.listenMin)+num(r.listenWideMin)) > 0 || (r.note && r.note.trim()) || (r.readBook && r.readBook.trim()) || (r.listenText && r.listenText.trim());
        const hasEn = (num(r.enWords)+num(r.readPages)+num(r.readMin)+num(r.listenMin)+num(r.listenWideMin)) > 0 || (r.readBook && r.readBook.trim()) || (r.listenText && r.listenText.trim());

        if(hasAny) anyDays += 1;
        if(hasEn) enDays += 1;

        totalWords += num(r.enWords);
        totalPages += num(r.readPages);
        totalReadMin += num(r.readMin);
        totalListenMin += num(r.listenMin);
        totalListenWide += num(r.listenWideMin);
      }

      $("kpiWords").textContent = `${totalWords}`;
      $("kpiRead").textContent = `${totalPages} é¡µ Â· ${totalReadMin} åˆ†`;
      $("kpiListen").textContent = `ç²¾å¬ ${totalListenMin} åˆ† Â· æ³›å¬ ${totalListenWide} åˆ†`;
      $("kpiTime").textContent = `${totalReadMin + totalListenMin + totalListenWide} åˆ†`;
      $("kpiDays").textContent = `æ€»è®¡ï¼š${anyDays} å¤©`;
      $("kpiDays2").textContent = `æœ‰è‹±è¯­è®°å½•ï¼š${enDays} å¤©`;

      // Books words
      const books = store.books || {};
      let sumWords = 0;
      const bookList = Object.entries(books).sort((a,b)=> a[0].localeCompare(b[0]));
      for(const [,w] of bookList) sumWords += num(w);
      $("kpiBookWords").textContent = `${sumWords} words`;

      // Book hint preview
      if(bookList.length){
        const preview = bookList.slice(0,4).map(([t,w]) => `${t}(${w})`).join(" Â· ");
        $("bookHint").textContent = `å·²ä¿å­˜ ${bookList.length} æœ¬ï¼š` + preview + (bookList.length>4 ? " â€¦" : "");
      }else{
        $("bookHint").textContent = "è¿˜æ²¡æœ‰æ·»åŠ å·²è¯»ä¹¦ç±ã€‚";
      }

      renderBackupBanner();
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /**********************
     * Backup reminder
     **********************/
    function renderBackupBanner(){
      const banner = $("backupBanner");
      const last = localStorage.getItem(DAYS_BACKUP_KEY);
      if(!last){
        banner.style.display = "block";
        banner.innerHTML = `âš ï¸ <strong>å¤‡ä»½æé†’ï¼š</strong> ä½ è¿˜æ²¡æœ‰å¯¼å‡ºè¿‡å¤‡ä»½ã€‚å»ºè®®æ¯å‘¨ç‚¹å‡»ä¸€æ¬¡ã€Œå¯¼å‡º JSONã€ã€‚`;
        return;
      }
      const lastTs = Number(last);
      if(!Number.isFinite(lastTs)){
        banner.style.display = "none";
        return;
      }
      const diffDays = Math.floor((Date.now() - lastTs) / (1000*60*60*24));
      if(diffDays >= 7){
        banner.style.display = "block";
        banner.innerHTML = `âš ï¸ <strong>å¤‡ä»½æé†’ï¼š</strong> è·ç¦»ä¸Šæ¬¡å¯¼å‡ºå·² <strong>${diffDays}</strong> å¤©ï¼Œå»ºè®®ç°åœ¨å¯¼å‡ºä¸€æ¬¡ JSONã€‚`;
      }else{
        banner.style.display = "none";
      }
    }

    /**********************
     * Actions
     **********************/
    $("saveBtn").addEventListener("click", ()=>{
      const r = getRecordFromForm();
      const store = readStore();
      store.daily[r.date] = r;
      writeStore(store);
      render();
      toast("å·²ä¿å­˜");
    });

    $("loadBtn").addEventListener("click", ()=>{
      const d = dateEl.value || isoToday();
      const store = readStore();
      const r = store.daily[d];
      if(r){
        setFormFromRecord(r);
        toast("å·²è½½å…¥");
      }else{
        clearForm();
        toast("è¯¥æ—¥æœŸæ²¡æœ‰è®°å½•ï¼ˆå·²æ¸…ç©ºè¡¨å•ï¼‰");
      }
    });

    $("clearBtn").addEventListener("click", ()=>{
      clearForm();
    });

    $("historyBody").addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const act = btn.dataset.act;
      const d = btn.dataset.date;
      if(!act || !d) return;

      if(act === "edit"){
        dateEl.value = d;
        const store = readStore();
        const r = store.daily[d];
        if(r){
          setFormFromRecord(r);
          toast("å·²è½½å…¥åˆ°è¡¨å•");
          window.scrollTo({ top: 0, behavior: "smooth" });
        }
      }

      if(act === "del"){
        if(!confirm(`ç¡®å®šåˆ é™¤ ${d} çš„è®°å½•å—ï¼Ÿ`)) return;
        const store = readStore();
        delete store.daily[d];
        writeStore(store);
        render();
        toast("å·²åˆ é™¤");
      }
    });

    rangeEl.addEventListener("change", render);

    /**********************
     * Export / Import
     **********************/
    $("exportBtn").addEventListener("click", ()=>{
      const store = readStore();
      const blob = new Blob([JSON.stringify(store, null, 2)], { type:"application/json" });
      const a = document.createElement("a");
      const stamp = isoToday().replaceAll("-","");
      a.href = URL.createObjectURL(blob);
      a.download = `sisi_en_backup_${stamp}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);

      localStorage.setItem(DAYS_BACKUP_KEY, String(Date.now()));
      renderBackupBanner();
      toast("å·²å¯¼å‡ºå¤‡ä»½");
    });
    $("importBtn")?.addEventListener("click", ()=> $("importFile").click());

    $("importFile").addEventListener("change", async (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        const obj = JSON.parse(text);

        if(!obj || typeof obj !== "object") throw new Error("æ ¼å¼ä¸å¯¹");
        if(!obj.daily) obj.daily = {};
        if(!obj.books) obj.books = {};

        const store = readStore();

        // merge: imported wins
        store.daily = { ...(store.daily||{}), ...(obj.daily||{}) };
        store.books = { ...(store.books||{}), ...(obj.books||{}) };

        writeStore(store);
        render();
        toast("å·²å¯¼å…¥");
      }catch(err){
        alert("å¯¼å…¥å¤±è´¥ï¼šè¯·ç¡®è®¤æ˜¯å¯¼å‡ºçš„ JSON æ–‡ä»¶ã€‚");
      }finally{
        e.target.value = "";
      }
    });

    /**********************
     * Books words
     **********************/
    $("addBookBtn").addEventListener("click", ()=>{
      const title = $("bookTitle").value.trim();
      const words = num($("bookWords").value);
      if(!title){
        toast("è¯·å…ˆå¡«ä¹¦å");
        return;
      }
      if(words <= 0){
        toast("words éœ€è¦æ˜¯æ­£æ•´æ•°");
        return;
      }
      const store = readStore();
      store.books[title] = words;
      writeStore(store);
      $("bookTitle").value = "";
      $("bookWords").value = "";
      render();
      toast("å·²ä¿å­˜ä¹¦ç± words");
    });

    $("clearBookBtn").addEventListener("click", ()=>{
      $("bookTitle").value = "";
      $("bookWords").value = "";
      toast("å·²æ¸…ç©º");
    });

    /**********************
     * Init
     **********************/
    (function init(){
      dateEl.value = isoToday();
      render();

      // é¦–æ¬¡æ‰“å¼€ï¼šè‡ªåŠ¨è½½å…¥ä»Šå¤©ï¼ˆå¦‚æœæœ‰ï¼‰
      const store = readStore();
      const r = store.daily[dateEl.value];
      if(r) setFormFromRecord(r);
    })();
  
</script>
</body>
</html>
